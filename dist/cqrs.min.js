/*
 * cqrs.js
 * Copyright 2014-2015 Thibault Morin
 * @license MIT
 */
!function(n,e){"use strict";"function"==typeof define&&define.amd?define("cqrsjs",[],e):"object"==typeof exports?module.exports=e():n.cqrs=e()}(this,function(){"use strict";function n(){h.debug&&console.log.apply(console,arguments)}function e(n){return n&&"function"==typeof n.then?n:new Promise(function(e){e(n)})}function r(n,e,r){var t=g.some(function(n){return n.commandName===e});t||g.push({owner:n,commandName:e,callback:r})}function t(n){g.filter(function(e){return e.owner===n}).forEach(function(n){g.splice(n,1)})}function u(n){var e=g.filter(function(e){return e.commandName===n});if(e.length>0)return e[0];throw new Error("unable to find the handler "+n)}function o(n,e,r){w.push({owner:n,eventName:e,callback:r})}function i(n){w.filter(function(e){return e.owner===n}).forEach(function(n){var e=w.indexOf(n);w.splice(e,1)})}function c(n){return w.filter(function(e){return e.eventName===n})}function a(n,e,r,t){var u,o=q.filter(function(r){return r.owner===n&&r.aggregateName===e});o.length>0?u=o[0]:(u={owner:n,aggregateName:e,listeners:[]},q.push(u)),u.listeners.push({eventName:r,callback:t})}function f(n){q.filter(function(e){return e.owner===n}).forEach(function(n){var e=q.indexOf(n);q.splice(e,1)})}function s(n,e){return q.filter(function(e){return e.aggregateName===n}).map(function(n){return n.listeners}).reduce(function(n,e){return n.concat(e)},[]).filter(function(n){return n.eventName===e})}function l(n,e,r){var t=y.filter(function(n){return n.queryName===e}).length>0;t||y.push({owner:n,queryName:e,queryFunction:r})}function v(n){y.filter(function(e){return e.owner===n}).forEach(function(n){var e=y.indexOf(n);y.splice(e,1)})}function m(n){var e=y.filter(function(e){return e.queryName===n});if(e.length>0)return e[0];throw new Error("unable to find the query "+n)}function d(n,e,r){return n?[n,e,r].join("-"):[e,r].join("-")}function h(h){function p(e,r,t){var o=d(D,"cmd",e);return new Promise(function(e){var i=u(o);t?t.sentOn=new Date:t={sentOn:new Date},n("cqrs - send - send command %s %o %o",o,r,t),e(i.callback(r,t))})}function g(e){function t(e){n("cqrs - when - add handler %s:%s",P,o),r(P,o,e)}var u={},o=d(D,"cmd",e);return u.invoke=t,u}function w(e,r,t){var u=d(D,"evt",e),o=c(u);t?t.publishedOn=new Date:t={publishedOn:new Date},n("cqrs - publish - publish event %s %o %o",u,r,t);var i=o.map(function(n){return Promise.resolve().then(function(){return n.callback(r,t)})});return Promise.all(i)}function q(e){function r(e){n("cqrs - on - add listener %s:%s",P,u),o(P,u,e)}var t={},u=d(D,"evt",e);return t.invoke=r,t}function y(e){function r(e){n("cqrs - calling - add query %s:%s",P,u),l(P,u,e)}var t={},u=d(D,"qry",e);return t.invoke=r,t}function N(){var e=Array.prototype.slice.call(arguments),r=e.shift(),t=d(D,"qry",r);return n("cqrs - call - call query %s:%s",P,t),Promise.resolve().then(function(){var n=m(t);return n.queryFunction.apply(null,e)})}function k(t){function u(t){function u(t){function u(u){function a(r,o){var i=t(r,o);return e(i).then(function(e){if(u&&e){o.appliedOn=new Date,n("cqrs - aggregate apply - %s:%s:%s",P,c,f);var r=s(c,f).map(function(n){return Promise.resolve().then(function(){return n.callback(e,o)})});return Promise.all(r).then(function(){return w(u,e,o)})}})}var f=d(D,"evt",u);return n("cqrs - aggregate when - add handler %s:%s",P,i),r(P,i,a),o}var a={};return a.apply=u,a}var o={},i=d(D,"cmd",t);return o.invoke=u,o}function o(e){function r(e){return n("cqrs - on - add listener %s:%s",P,u),a(P,c,u,e),i}var t={},u=d(D,"evt",e);return t.invoke=r,t}var i={},c=d(D,"agg",t);return i.when=u,i.on=o,i}function O(){t(P),i(P),f(P),v(P)}var P,D,E;return E={},h=h||{},P=h.owner||"owner-"+b++,D=h.namespace,E.send=p,E.when=g,E.publish=w,E.on=q,E.calling=y,E.call=N,E.aggregate=k,E.destroy=O,E}function p(n,e,r,t){g=n,w=e,q=r,y=t}var g=[],w=[],q=[],y=[],b=0;return h.setDefaultRepos=p,h});
//# sourceMappingURL=cqrs.js.map