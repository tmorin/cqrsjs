/*
 * cqrsjs
 * Thibault Morin
 * @license MIT
 */
!function(n,e){"use strict";"function"==typeof define&&define.amd?define("cqrsjs",[],e):"object"==typeof exports?module.exports=e():n.cqrs=e()}(this,function(){"use strict";function n(){m.debug&&console.log.apply(console,arguments)}function e(n,e,r){var t=h.some(function(n){return n.commandName===e});t||h.push({owner:n,commandName:e,callback:r})}function r(n){h.filter(function(e){return e.owner===n}).forEach(function(n){h.splice(n,1)})}function t(n){var e=h.filter(function(e){return e.commandName===n});if(e.length>0)return e[0];throw new Error("unable to find the handler "+n)}function u(n,e,r){g.push({owner:n,eventName:e,callback:r})}function o(n){g.filter(function(e){return e.owner===n}).forEach(function(n){var e=g.indexOf(n);g.splice(e,1)})}function i(n){return g.filter(function(e){return e.eventName===n})}function c(n,e,r,t){var u,o=w.filter(function(r){return r.owner===n&&r.aggregateName===e});o.length>0?u=o[0]:(u={owner:n,aggregateName:e,listeners:[]},w.push(u)),u.listeners.push({eventName:r,callback:t})}function a(n){w.filter(function(e){return e.owner===n}).forEach(function(n){var e=w.indexOf(n);w.splice(e,1)})}function f(n,e){return w.filter(function(e){return e.aggregateName===n}).map(function(n){return n.listeners}).reduce(function(n,e){return n.concat(e)},[]).filter(function(n){return n.eventName===e})}function s(n,e,r){var t=q.filter(function(n){return n.queryName===e}).length>0;t||q.push({owner:n,queryName:e,queryFunction:r})}function l(n){q.filter(function(e){return e.owner===n}).forEach(function(n){var e=q.indexOf(n);q.splice(e,1)})}function v(n){var e=q.filter(function(e){return e.queryName===n});if(e.length>0)return e[0];throw new Error("unable to find the query "+n)}function d(n,e,r){return n?[n,e,r].join("-"):[e,r].join("-")}function m(m){function p(e,r,u){var o=d(D,"cmd",e);return new Promise(function(e){var i=t(o);u?u.sentOn=new Date:u={sentOn:new Date},n("cqrs - send - send command %s %o %o",o,r,u),e(i.callback(r,u))})}function h(r){function t(r){n("cqrs - when - add handler %s:%s",O,o),e(O,o,r)}var u={},o=d(D,"cmd",r);return u.invoke=t,u}function g(e,r,t){var u=d(D,"evt",e),o=i(u);t?t.publishedOn=new Date:t={publishedOn:new Date},n("cqrs - publish - publish event %s %o %o",u,r,t);var c=o.map(function(n){return Promise.resolve().then(function(){return n.callback(r,t)})});return Promise.all(c)}function w(e){function r(e){n("cqrs - on - add listener %s:%s",O,o),u(O,o,e)}var t={},o=d(D,"evt",e);return t.invoke=r,t}function q(e){function r(e){n("cqrs - calling - add query %s:%s",O,u),s(O,u,e)}var t={},u=d(D,"qry",e);return t.invoke=r,t}function b(){var e=Array.prototype.slice.call(arguments),r=e.shift(),t=d(D,"qry",r);return n("cqrs - call - call query %s:%s",O,t),Promise.resolve().then(function(){var n=v(t);return n.queryFunction.apply(null,e)})}function N(r){function t(r){function t(r){function t(t){function c(e,u){var o=r(e,u);if(t&&o){u.appliedOn=new Date,n("cqrs - aggregate apply - %s:%s:%s",O,i,a);var c=f(i,a).map(function(n){return new Promise(function(e){e(n.callback(o,u))})});return Promise.all(c).then(function(){return g(t,o,u)})}}var a=d(D,"evt",t);return n("cqrs - aggregate when - add handler %s:%s",O,o),e(O,o,c),u}var c={};return c.apply=t,c}var u={},o=d(D,"cmd",r);return u.invoke=t,u}function u(e){function r(e){return n("cqrs - on - add listener %s:%s",O,u),c(O,i,u,e),o}var t={},u=d(D,"evt",e);return t.invoke=r,t}var o={},i=d(D,"agg",r);return o.when=t,o.on=u,o}function k(){r(O),o(O),a(O),l(O)}var O,D,E;return E={},m=m||{},O=m.owner||"owner-"+y++,D=m.namespace,E.send=p,E.when=h,E.publish=g,E.on=w,E.calling=q,E.call=b,E.aggregate=N,E.destroy=k,E}function p(n,e,r,t){h=n,g=e,w=r,q=t}var h=[],g=[],w=[],q=[],y=0;return m.setDefaultRepos=p,m});
//# sourceMappingURL=cqrs.js.map