/*! cqrsjs-master - v0.0.0 - 2014-05-26 */
!function(a,b){"function"==typeof define&&define.amd?define(function(){return b(a)}):"undefined"!=typeof module?module.exports=b(a):"undefined"!=typeof a.exports?exports.cqrs=b(a):a.cqrs=b(a)}(this,function(a){"use strict";function b(a,b,c){var d=p.some(function(a){return a.commandName===b});d||p.push({owner:a,commandName:b,callback:c})}function c(a){p.filter(function(b){return b.owner===a}).forEach(function(a){p.splice(a,1)})}function d(a){var b=p.filter(function(b){return b.commandName===a});return b.length>0?b[0]:void 0}function e(a,b,c){q.push({owner:a,eventName:b,callback:c})}function f(a){q.filter(function(b){return b.owner===a}).forEach(function(a){var b=q.indexOf(a);q.splice(b,1)})}function g(a){return q.filter(function(b){return b.eventName===a})}function h(a,b,c,d){var e,f=r.filter(function(c){return c.owner===a&&c.aggregateName===b});f.length>0?e=f[0]:(e={owner:a,aggregateName:b,listeners:[]},r.push(e)),e.listeners.push({eventName:c,callback:d})}function i(a){r.filter(function(b){return b.owner===a}).forEach(function(a){var b=r.indexOf(a);r.splice(b,1)})}function j(a,b){return r.filter(function(b){return b.aggregateName===a}).map(function(a){return a.listeners}).reduce(function(a,b){return a.concat(b)},[]).filter(function(a){return a.eventName===b})}function k(a,b,c){var d=s.filter(function(a){return a.queryName===b}).length>0;d||s.push({owner:a,queryName:b,queryFunction:c})}function l(a){return s.filter(function(b){return b.queryName===a})[0]}function m(a,b,c){return a?[a,b,c].join("-"):[b,c].join("-")}function n(o,p){function q(a,b){var c=m(B,"qry",a);return n.debug&&console.log("cqrs - add query %s:%s",A,c),k(A,a,b),C}function r(){var b=Array.prototype.slice.call(arguments),c=b.shift(),d=m(B,"qry",c);return n.debug&&console.log("cqrs - query - call query %s:%s",A,d),new Promise(function(c,e){var f=l(d);if(f)try{var g=f.queryFunction.apply(a,b);c(g)}catch(h){e(h)}else e(new Error("unable to find the query: "+d))})}function s(a,c){var e=m(B,"cmd",a);return d(e)||(n.debug&&console.log("cqrs - handle - add handler %s:%s",A,e),b(A,e,c)),C}function u(a,b,c){return new Promise(function(e,f){var g=m(B,"cmd",a),h=d(g);h?(n.debug&&console.log("cqrs - send - send command %s %o %o",g,b,c),e(h.callback(b,c))):f(new Error("unable to found an handler"))})}function v(a,b){var c=m(B,"evt",a);return n.debug&&console.log("cqrs - listen - add listener %s:%s",A,c),e(A,c,b),C}function w(a,b,c){var d=m(B,"evt",a);n.debug&&console.log("cqrs - publish - publish event %s %o %o",d,b,c);var e=g(d),f=e.map(function(a){return new Promise(function(d,e){try{var f=a.callback(b,c);d(f)}catch(g){e(g)}})});return Promise.all(f)}function x(a,b){function c(a,b,c){var d=m(B,"evt",a);n.debug&&console.log("cqrs - aggregate apply - %s:%s:%s",A,g,d);var e=j(g,d).map(function(a){return new Promise(function(d,e){try{var f=a.callback(b,c);d(f)}catch(g){e(g)}})});return Promise.all(e).then(function(){var d=w(a,b,c);return d})}function d(a){return function(b,d){a(b,d,c)}}function e(a,b){return s(a,d(b)),i}function f(a,b){var c=m(B,"evt",a);n.debug&&console.log("cqrs - aggregate listener - add listener %s:%s:%s",A,g,c),h(A,g,c,b)}var g=m(B,"agg",a),i={};return i.apply=c,i.handle=e,i.listen=f,b&&b(e,f),i}function y(){c(A),f(A),i(A),removeQueries(A)}var z,A,B,C;return C={},z="function"==typeof o&&o,p="function"==typeof o?p:o,A=p&&p.owner||"owner-"+t++,B=p&&p.namespace,C.register=q,C.call=r,C.handle=s,C.send=u,C.listen=v,C.publish=w,C.aggregate=x,C.destroy=y,z&&z(u,s,w,v,x,query,q),C}function o(a,b,c,d){p=a,q=b,r=c,s=d}var p=[],q=[],r=[],s=[],t=0;return n.setDefaultRepos=o,n});
//# sourceMappingURL=cqrs.map