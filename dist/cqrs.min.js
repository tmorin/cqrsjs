/*! cqrsjs-master - v0.0.0 - 2014-05-22 */
!function(a){"use strict";function b(a,b,c){var d=p.some(function(a){return a.commandName===b});d||p.push({owner:a,commandName:b,callback:c})}function c(a){p.filter(function(b){return b.owner===a}).forEach(function(a){p.splice(a,1)})}function d(a){var b=p.filter(function(b){return b.commandName===a});return b.length>0?b[0]:void 0}function e(a,b,c){q.push({owner:a,eventName:b,callback:c})}function f(a){q.filter(function(b){return b.owner===a}).forEach(function(a){var b=q.indexOf(a);q.splice(b,1)})}function g(a){return q.filter(function(b){return b.eventName===a})}function h(a,b,c,d){var e,f=r.filter(function(c){return c.owner===a&&c.aggregateName===b});f.length>0?e=f[0]:(e={owner:a,aggregateName:b,listeners:[]},r.push(e)),e.listeners.push({eventName:c,callback:d})}function i(a){r.filter(function(b){return b.owner===a}).forEach(function(a){var b=r.indexOf(a);r.splice(b,1)})}function j(a,b){return r.filter(function(b){return b.aggregateName===a}).map(function(a){return a.listeners}).reduce(function(a,b){return a.concat(b)},[]).filter(function(a){return a.eventName===b})}function k(a,b,c,d){var e=s.filter(function(a){return a.namespace===b&&a.queryName===c}).length>0;e||s.push({owner:a,namespace:b,queryName:c,queryFunction:d})}function l(a){return s.filter(function(b){return b.namespace===a})}function m(a,b,c){return a?[a,b,c].join("-"):[b,c].join("-")}function n(a,o){function p(a){return function(){var b=Array.prototype.slice.call(arguments);return new Promise(function(c,d){try{var e=a.apply(a,b);c(e)}catch(f){d(f)}})}}function q(){var a={};return l(A).forEach(function(b){a[b.queryName]=p(b.queryFunction)}),a}function r(a,c){var e=m(A,"cmd",a);return d(e)||(n.debug&&console.log("cqrs - handle - add handler %s:%s",z,e),b(z,e,c)),B}function s(a,b,c){return new Promise(function(e,f){var g=m(A,"cmd",a),h=d(g);h?(n.debug&&console.log("cqrs - send - send command %s %o %o",g,b,c),e(h.callback(b,c,q))):f(new Error("unable to found an handler"))})}function u(a,b){var c=m(A,"evt",a);return n.debug&&console.log("cqrs - listen - add listener %s:%s",z,c),e(z,c,b),B}function v(a,b,c){var d=m(A,"evt",a);n.debug&&console.log("cqrs - publish - publish event %s %o %o",d,b,c);var e=g(d),f=e.map(function(a){return new Promise(function(d,e){try{var f=a.callback(b,c,q);d(f)}catch(g){e(g)}})});return Promise.all(f)}function w(a,b){function c(a,b,c){var d=m(A,"evt",a);n.debug&&console.log("cqrs - aggregate apply - %s:%s:%s",z,g,d);var e=j(g,d).map(function(a){return new Promise(function(d,e){try{var f=a.callback(b,c,q);d(f)}catch(g){e(g)}})});return Promise.all(e).then(function(){var d=v(a,b,c);return d})}function d(a){return function(b,d,e){a(b,d,e,c)}}function e(a,b){return r(a,d(b)),i}function f(a,b){var c=m(A,"evt",a);n.debug&&console.log("cqrs - aggregate listener - add listener %s:%s:%s",z,g,c),h(z,g,c,b)}var g=m(A,"agg",a),i={};return i.apply=c,i.handle=e,i.listen=f,b&&b(e,f),i}function x(){c(z),f(z),i(z),removeQueries(z)}var y,z,A,B;return B={},y="function"==typeof a&&a,o="function"==typeof a?o:a,z=o&&o.owner||"owner-"+t++,A=o&&o.namespace,B.queries=q,q.add=function(a,b){return n.debug&&console.log("cqrs - add query %s:%s:%s",z,A,a),k(z,A,a,b),B},B.handle=r,B.send=s,B.listen=u,B.publish=v,B.aggregate=w,B.destroy=x,y&&y(s,r,v,u,w,query),B}function o(a,b,c,d){p=a,q=b,r=c,s=d}var p=[],q=[],r=[],s=[],t=0;n.setDefaultRepos=o,a.cqrs=n}(this);
//# sourceMappingURL=cqrs.map